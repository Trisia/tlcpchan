# TLCP Channel 需求文档

## 1. 引言

### 1.1 文档目的

本文档详细描述 TLCP Channel 项目的功能需求、非功能需求和约束条件，作为项目开发和验收的依据。

### 1.2 项目背景

TLCP（传输层密码协议）是中国国家密码管理局发布的国密SSL协议标准（GB/T 38636-2020）。目前越来越多的国产化信息系统采用TLCP协议进行安全通信，但在实际部署中常需要与现有的TLS协议系统进行互操作。

本项目旨在提供一个TLCP/TLS双协议代理工具，解决以下问题：
- 国密应用与传统TLS应用的互联互通
- 现有系统平滑迁移到国密协议
- 开发测试环境的国密协议支持

### 1.3 术语定义

| 术语 | 定义 |
|------|------|
| TLCP | 传输层密码协议，国密SSL协议 |
| TLS | Transport Layer Security，传输层安全协议 |
| SM2 | 国密椭圆曲线公钥密码算法 |
| SM3 | 国密密码杂凑算法 |
| SM4 | 国密分组密码算法 |
| 代理实例 | 一个独立运行的代理服务配置单元 |

## 2. 用户角色

| 角色 | 描述 | 主要需求 |
|------|------|----------|
| 系统管理员 | 负责系统部署和维护 | 配置管理、状态监控、日志查看 |
| 运维人员 | 日常运维操作 | 实例启停、证书更新、故障排查 |
| 开发人员 | 应用开发测试 | 快速部署、协议调试 |

## 3. 功能需求

### 3.1 代理功能

#### 3.1.1 服务端代理（FR-001）

**需求描述**：作为TLCP/TLS服务端，接收加密流量并转发到明文TCP服务。

**功能要点**：
- 支持TLCP协议（SM2证书）
- 支持TLS协议（RSA/ECC证书）
- 支持协议自动识别（auto模式）
- 支持单向认证（服务端证书）
- 支持双向认证（客户端+服务端证书）
- 支持自定义密码套件配置
- 支持协议版本配置
- 支持会话复用配置

**输入**：
- 监听地址和端口
- 目标TCP服务地址
- 协议类型（auto/tlcp/tls）
- 认证模式（none/one-way/mutual）
- 证书/密钥文件路径
- CA证书路径（双向认证）
- 协议参数配置

**输出**：
- 代理服务运行状态
- 连接日志
- 流量统计

**验收标准**：
- [ ] TLCP客户端可成功连接并通信
- [ ] TLS客户端可成功连接并通信
- [ ] auto模式能正确识别协议类型
- [ ] 双向认证正常工作
- [ ] 配置的密码套件生效

#### 3.1.2 客户端代理（FR-002）

**需求描述**：接收明文TCP流量，加密后转发到TLCP/TLS服务端。

**功能要点**：
- 支持连接TLCP服务端
- 支持连接TLS服务端
- 支持协议自动检测（auto模式）
- 支持服务端证书验证
- 支持客户端证书（双向认证）
- 支持SNI配置

**输入**：
- 监听地址和端口
- 目标服务地址
- 协议类型（auto/tlcp/tls）
- 服务端CA证书路径
- 客户端证书/密钥路径（双向认证）
- SNI主机名

**输出**：
- 代理服务运行状态
- 连接日志
- 流量统计

**验收标准**：
- [ ] 可成功连接TLCP服务端
- [ ] 可成功连接TLS服务端
- [ ] auto模式能正确检测目标协议
- [ ] 证书验证正常工作

#### 3.1.3 HTTP服务端代理（FR-003）

**需求描述**：在服务端代理基础上增加HTTP协议处理能力。

**功能要点**：
- 支持HTTP/1.x协议
- 支持请求头配置（添加/删除/修改）
- 支持响应头配置（添加/删除/修改）
- 支持变量替换（如$remote_addr）
- 支持请求日志记录

**配置示例**：
```yaml
http:
  request_headers:
    add:
      X-Proxy: "tlcpchan"
      X-Real-IP: "$remote_addr"
    remove:
      - "X-Forwarded-For"
  response_headers:
    add:
      Server: "TLCPChan/1.0"
```

**验收标准**：
- [ ] HTTP请求正确转发
- [ ] 请求头按配置修改
- [ ] 响应头按配置修改
- [ ] 变量正确替换

#### 3.1.4 HTTP客户端代理（FR-004）

**需求描述**：作为HTTP客户端代理，将明文HTTP请求转发到HTTPS服务。

**功能要点**：
- 支持HTTP/1.x协议
- 支持连接TLCP服务端
- 支持连接TLS服务端
- 支持协议自动检测
- 支持头部配置

**验收标准**：
- [ ] 明文HTTP请求正确转发到HTTPS服务
- [ ] 协议自动检测正常工作
- [ ] 头部配置生效

### 3.2 配置管理

#### 3.2.1 YAML配置文件（FR-005）

**需求描述**：通过YAML配置文件管理所有配置。

**功能要点**：
- 支持YAML格式配置文件
- 支持多个代理实例配置
- 支持配置验证
- 默认配置文件路径：./config/config.yaml
- 支持命令行指定配置文件路径

**验收标准**：
- [ ] YAML配置正确解析
- [ ] 配置验证有效
- [ ] 配置文件路径可配置

#### 3.2.2 配置热更新（FR-006）

**需求描述**：运行时通过API触发配置重新加载。

**功能要点**：
- 通过API接口触发配置重载
- 配置验证失败时保持原配置
- 配置变更日志记录
- 实例自动重启（配置变更时）

**验收标准**：
- [ ] API触发重载成功
- [ ] 配置验证失败时不影响运行
- [ ] 配置变更记录到日志

### 3.3 证书管理

#### 3.3.1 证书加载（FR-007）

**需求描述**：加载和管理TLCP/TLS证书。

**功能要点**：
- 支持PEM格式证书
- 支持SM2证书（TLCP）
- 支持RSA/ECC证书（TLS）
- 证书加载错误处理

**验收标准**：
- [ ] PEM证书正确加载
- [ ] SM2证书正确解析
- [ ] 错误证书给出明确提示

#### 3.3.2 证书热更新（FR-008）

**需求描述**：支持证书文件更新后热加载。

**功能要点**：
- 通过API触发证书重载
- 使用GetCertificate回调实现
- 新连接使用新证书
- 旧连接不受影响

**验收标准**：
- [ ] API触发证书重载成功
- [ ] 新连接使用新证书
- [ ] 旧连接正常工作

#### 3.3.3 证书生成（FR-009）

**需求描述**：首次启动时自动生成测试证书。

**功能要点**：
- 生成根CA证书（SM2/RSA）
- 生成服务端证书（SM2/RSA）
- 生成客户端证书（SM2/RSA）
- 证书文件权限设置（600）

**验收标准**：
- [ ] 首次启动自动生成证书
- [ ] 生成的证书可用于TLCP
- [ ] 生成的证书可用于TLS
- [ ] 文件权限正确

### 3.4 日志管理

#### 3.4.1 系统日志（FR-010）

**需求描述**：系统运行日志管理。

**功能要点**：
- 支持多日志级别（debug/info/warn/error）
- 支持文件输出
- 支持控制台输出
- 支持日志文件轮转
- 支持日志文件压缩
- 使用Go标准库log

**配置参数**：
- level：日志级别
- file：日志文件路径
- max_size：单文件最大大小
- max_backups：最大备份数
- max_age：最大保留天数
- compress：是否压缩

**验收标准**：
- [ ] 日志正确输出到文件
- [ ] 日志正确输出到控制台
- [ ] 日志轮转正常工作
- [ ] 日志级别过滤正确

#### 3.4.2 实例日志（FR-011）

**需求描述**：每个代理实例可配置独立日志。

**功能要点**：
- 实例独立日志文件
- 未配置时使用系统日志
- 支持日志开关控制
- 支持通过API查询日志

**验收标准**：
- [ ] 实例日志独立输出
- [ ] 未配置时使用系统日志
- [ ] 日志开关生效

### 3.5 流量统计

#### 3.5.1 统计收集（FR-012）

**需求描述**：收集代理实例的流量统计数据。

**功能要点**：
- 连接数统计（总数/活跃）
- 流量统计（接收/发送字节）
- 请求统计（HTTP）
- 错误统计
- 延迟统计
- 可配置统计间隔

**验收标准**：
- [ ] 统计数据准确
- [ ] 统计间隔可配置
- [ ] 统计可开关

#### 3.5.2 统计查询（FR-013）

**需求描述**：通过API查询统计数据。

**功能要点**：
- 查询单个实例统计
- 查询所有实例统计
- 实时统计数据

**验收标准**：
- [ ] API返回正确统计数据
- [ ] 数据实时更新

### 3.6 API服务

#### 3.6.1 RESTful API（FR-014）

**需求描述**：提供RESTful风格的API接口。

**功能要点**：
- 实例管理API（CRUD）
- 实例控制API（启停/重载）
- 配置管理API
- 证书管理API
- 统计查询API
- 系统信息API
- 无鉴权（内网使用）

**验收标准**：
- [ ] 所有API正常工作
- [ ] 返回格式统一
- [ ] 错误处理正确

### 3.7 Web UI

#### 3.7.1 仪表盘（FR-015）

**需求描述**：提供系统概览和监控仪表盘。

**功能要点**：
- 系统状态概览
- 实例状态列表
- 流量统计图表
- 资源使用情况

**验收标准**：
- [ ] 数据正确显示
- [ ] 图表可交互

#### 3.7.2 实例管理（FR-016）

**需求描述**：通过UI管理代理实例。

**功能要点**：
- 实例列表展示
- 实例创建/编辑/删除
- 实例启停控制
- 实例状态监控

**验收标准**：
- [ ] 实例CRUD操作正常
- [ ] 实例控制操作正常

#### 3.7.3 证书管理（FR-017）

**需求描述**：通过UI管理证书。

**功能要点**：
- 证书列表展示
- 证书信息查看
- 证书上传
- 证书生成

**验收标准**：
- [ ] 证书列表正确显示
- [ ] 证书操作正常

#### 3.7.4 日志查看（FR-018）

**需求描述**：通过UI查看日志。

**功能要点**：
- 日志实时查看
- 日志过滤
- 日志搜索

**验收标准**：
- [ ] 日志正确显示
- [ ] 过滤和搜索正常

### 3.8 CLI工具

#### 3.8.1 命令行控制（FR-019）

**需求描述**：提供命令行工具管理服务。

**功能要点**：
- 启动/停止服务
- 查看服务状态
- 管理实例
- 管理配置
- 管理证书

**验收标准**：
- [ ] 所有命令正常工作
- [ ] 输出格式清晰

### 3.9 部署支持

#### 3.9.1 多平台支持（FR-020）

**需求描述**：支持多平台多架构部署。

**功能要点**：
- 支持Linux（x86_64/arm64/loongarch）
- 支持Windows（x86_64/arm64）
- 支持macOS（x86_64/arm64）

**验收标准**：
- [ ] 各平台二进制正常运行
- [ ] 各平台安装包可用

#### 3.9.2 安装包（FR-021）

**需求描述**：提供各平台安装包。

**功能要点**：
- Linux：.deb、.rpm、.tar.gz
- Windows：.msi、.zip
- macOS：.pkg、.tar.gz

**验收标准**：
- [ ] 安装包正确安装
- [ ] 安装后可正常运行

#### 3.9.3 systemd支持（FR-022）

**需求描述**：支持Linux systemd服务部署。

**功能要点**：
- 提供service文件
- 支持开机自启
- 支持服务管理

**验收标准**：
- [ ] systemd服务正常启动
- [ ] 服务管理命令正常

#### 3.9.4 Docker支持（FR-023）

**需求描述**：支持Docker容器部署。

**功能要点**：
- 提供Dockerfile
- 支持环境变量配置
- 支持数据卷挂载

**验收标准**：
- [ ] 容器正常启动
- [ ] 服务正常工作

## 4. 非功能需求

### 4.1 性能需求

| 指标 | 要求 |
|------|------|
| 并发连接 | 支持10000+并发连接 |
| 吞吐量 | 支持1Gbps+吞吐量 |
| 延迟 | 代理增加延迟<1ms |
| 内存 | 空闲状态内存<50MB |

### 4.2 可靠性需求

| 指标 | 要求 |
|------|------|
| 可用性 | 99.9%可用性 |
| 故障恢复 | 自动重连、优雅重启 |
| 数据安全 | 配置和证书安全存储 |

### 4.3 安全需求

| 指标 | 要求 |
|------|------|
| 证书安全 | 私钥文件权限600 |
| 日志安全 | 不记录敏感信息 |
| 网络安全 | API默认绑定本地 |

### 4.4 可维护性需求

| 指标 | 要求 |
|------|------|
| 日志 | 完整的运行日志 |
| 监控 | 提供统计和状态API |
| 文档 | 完整的使用文档 |

### 4.5 兼容性需求

| 指标 | 要求 |
|------|------|
| Go版本 | Go 1.21+ |
| TLCP | GB/T 38636-2020 |
| TLS | TLS 1.0-1.3 |
| HTTP | HTTP/1.0-1.1 |

## 5. 约束条件

### 5.1 技术约束

- 代理核心使用Go语言开发
- 前端使用Vue 3 + TypeScript
- 最小化第三方依赖
- 使用gotlcp库处理TLCP协议
- 使用Go标准库log处理日志
- 使用Go标准库net/http处理HTTP API

### 5.2 部署约束

- 支持独立进程部署
- 支持容器化部署
- 支持systemd服务部署

### 5.3 开发约束

- 使用Git进行版本控制
- 使用GitHub Actions进行CI/CD
- 遵循Go代码规范
- 代码需要有测试覆盖

## 6. 需求优先级

### P0 - 必须实现

- FR-001 服务端代理
- FR-002 客户端代理
- FR-005 YAML配置文件
- FR-007 证书加载
- FR-010 系统日志
- FR-014 RESTful API

### P1 - 应该实现

- FR-003 HTTP服务端代理
- FR-004 HTTP客户端代理
- FR-006 配置热更新
- FR-008 证书热更新
- FR-009 证书生成
- FR-011 实例日志
- FR-012 统计收集
- FR-015 仪表盘
- FR-016 实例管理UI
- FR-020 多平台支持

### P2 - 可以实现

- FR-013 统计查询
- FR-017 证书管理UI
- FR-018 日志查看UI
- FR-019 CLI工具
- FR-021 安装包
- FR-022 systemd支持
- FR-023 Docker支持

## 7. 验收标准

### 7.1 功能验收

- 所有P0需求实现并通过测试
- 所有P1需求实现并通过测试
- 所有API接口正常工作
- 所有UI功能正常工作

### 7.2 性能验收

- 并发连接测试通过
- 吞吐量测试通过
- 延迟测试通过
- 内存使用测试通过

### 7.3 部署验收

- 各平台安装包可用
- systemd服务正常
- Docker容器正常

## 8. 附录

### 8.1 参考标准

- GB/T 38636-2020 信息安全技术 传输层密码协议
- RFC 8446 The TLS Protocol Version 1.3
- RFC 5246 The TLS Protocol Version 1.2

### 8.2 参考项目

- github.com/Trisia/gotlcp - TLCP协议实现
- github.com/emmansun/gmsm - 国密算法库
- github.com/emmansun/mksmcert - 国密证书生成工具
